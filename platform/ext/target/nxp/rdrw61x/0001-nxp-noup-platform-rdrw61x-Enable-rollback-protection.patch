From 88699cda25e901a0c74eae03438bca58b9add87f Mon Sep 17 00:00:00 2001
From: Stefan Krug <stefan.krug@nxp.com>
Date: Wed, 15 Nov 2023 18:24:58 +0100
Subject: [PATCH] [nxp noup] platform: rdrw61x: Enable rollback protection for
 ITS.

---
 .../rdrw61x/CMSIS_Driver/Driver_Flash_iap_rw61x_iped.c   | 2 +-
 platform/include/tfm_plat_nv_counters.h                  | 5 +++++
 .../tfm_internal_trusted_storage.yaml                    | 3 +++
 secure_fw/partitions/platform/platform_sp.c              | 9 +++++++++
 4 files changed, 18 insertions(+), 1 deletion(-)

diff --git a/platform/ext/target/nxp/rdrw61x/CMSIS_Driver/Driver_Flash_iap_rw61x_iped.c b/platform/ext/target/nxp/rdrw61x/CMSIS_Driver/Driver_Flash_iap_rw61x_iped.c
index b9f3e2ac8..bb23bbc2d 100644
--- a/platform/ext/target/nxp/rdrw61x/CMSIS_Driver/Driver_Flash_iap_rw61x_iped.c
+++ b/platform/ext/target/nxp/rdrw61x/CMSIS_Driver/Driver_Flash_iap_rw61x_iped.c
@@ -168,7 +168,7 @@ static const ARM_FLASH_CAPABILITIES DriverCapabilities = {
 #if defined (RW61X_IPED_ITS_ROLLBACK_PROTECTION_ENABLE)
 #define IPED_ROLLBACK_PROTECTION_USER_CONFIG RW61X_IPED_ITS_ROLLBACK_PROTECTION_ENABLE
 #else
-#define IPED_ROLLBACK_PROTECTION_USER_CONFIG 0
+#define IPED_ROLLBACK_PROTECTION_USER_CONFIG 1
 #endif
 
 // To disable certain features (for easier debugging) the following can be adapted. Note, some features
diff --git a/platform/include/tfm_plat_nv_counters.h b/platform/include/tfm_plat_nv_counters.h
index 5a5da555c..9d47a371b 100644
--- a/platform/include/tfm_plat_nv_counters.h
+++ b/platform/include/tfm_plat_nv_counters.h
@@ -30,6 +30,8 @@
 #define PLATFORM_NS_NV_COUNTERS 0
 #endif
 
+#define PLATFORM_ITS_NV_COUNTERS
+
 enum tfm_nv_counter_t {
     PLAT_NV_COUNTER_PS_0 = 0,  /* Used by PS service */
     PLAT_NV_COUNTER_PS_1,      /* Used by PS service */
@@ -47,6 +49,9 @@ enum tfm_nv_counter_t {
     PLAT_NV_COUNTER_NS_1,      /* Used by NS */
     PLAT_NV_COUNTER_NS_2,      /* Used by NS */
 
+    PLAT_NV_COUNTER_ITS_0,     /* Used by ITS service */
+    PLAT_NV_COUNTER_ITS_1,     /* Used by ITS service */
+
     PLAT_NV_COUNTER_MAX,
     PLAT_NV_COUNTER_BOUNDARY = UINT32_MAX  /* Fix  tfm_nv_counter_t size
                                               to 4 bytes */
diff --git a/secure_fw/partitions/internal_trusted_storage/tfm_internal_trusted_storage.yaml b/secure_fw/partitions/internal_trusted_storage/tfm_internal_trusted_storage.yaml
index 173dc34c2..f805aae0f 100644
--- a/secure_fw/partitions/internal_trusted_storage/tfm_internal_trusted_storage.yaml
+++ b/secure_fw/partitions/internal_trusted_storage/tfm_internal_trusted_storage.yaml
@@ -24,5 +24,8 @@
       "version_policy": "STRICT",
       "mm_iovec": "enable",
     }
+  ],
+  "dependencies": [
+    "TFM_PLATFORM_SERVICE"
   ]
 }
diff --git a/secure_fw/partitions/platform/platform_sp.c b/secure_fw/partitions/platform/platform_sp.c
index 6099a8f48..a564e7e27 100644
--- a/secure_fw/partitions/platform/platform_sp.c
+++ b/secure_fw/partitions/platform/platform_sp.c
@@ -74,6 +74,15 @@ static enum tfm_platform_err_t nv_counter_permissions_check(
         } else {
             return TFM_PLATFORM_ERR_NOT_SUPPORTED;
         }
+#if defined(TFM_PARTITION_INTERNAL_TRUSTED_STORAGE) && defined(PLATFORM_ITS_NV_COUNTERS)
+    case PLAT_NV_COUNTER_ITS_0:
+    case PLAT_NV_COUNTER_ITS_1:
+        if (client_id == TFM_SP_ITS) {
+            return TFM_PLATFORM_ERR_SUCCESS;
+        } else {
+            return TFM_PLATFORM_ERR_NOT_SUPPORTED;
+        }
+#endif
     default:
         return TFM_PLATFORM_ERR_NOT_SUPPORTED;
     }
-- 
2.39.2.windows.1

